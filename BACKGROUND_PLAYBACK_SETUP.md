# バックグラウンド再生機能の追加手順

## 📋 追加された機能

✅ **バックグラウンド再生**: ホーム画面に戻っても音楽が流れ続けます
✅ **ロック画面コントロール**: ロック画面から再生/一時停止できます
✅ **コントロールセンター対応**: コントロールセンターから操作可能
✅ **Now Playing表示**: 曲名とアーティスト名が表示されます
✅ **次の曲/前の曲**: プレイリストの曲送り/曲戻しに対応

## 🔧 Xcodeでの設定手順

### 1. 新しいファイルを追加

プロジェクトに `AppDelegate.swift` を追加してください。

**手順:**
1. プロジェクトフォルダを右クリック
2. "Add Files to 'EarPhoneMusic'..."
3. `AppDelegate.swift` を選択
4. ✅ "Copy items if needed" にチェック
5. "Add" をクリック

### 2. 既存ファイルを更新

以下のファイルを新しいバージョンに置き換えてください:

- `MusicViewModel.swift` （バックグラウンド再生とメディアコントロール機能を追加）
- `EarPhoneMusicApp.swift` （AppDelegateを統合）

**手順:**
1. 既存のファイルの内容を全て選択（⌘ + A）
2. 削除
3. 新しいコードをコピー＆ペースト
4. 保存（⌘ + S）

### 3. Info.plist の設定

Info.plistに **必ず** 以下を追加してください:

#### 方法A: GUIで追加

1. Info.plistを開く
2. 右クリック → "Add Row"
3. 以下を追加:

```
Key: Required background modes (UIBackgroundModes)
Type: Array
  - Item 0: App plays audio or streams audio/video using AirPlay (audio)
```

#### 方法B: ソースコードで追加

Info.plistを右クリック → "Open As" → "Source Code"

`</dict>` の直前に以下を追加:

```xml
<key>UIBackgroundModes</key>
<array>
    <string>audio</string>
</array>

<key>NSAppTransportSecurity</key>
<dict>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
</dict>
```

### 4. Signing & Capabilities の確認

1. プロジェクト設定を開く
2. "Signing & Capabilities" タブを選択
3. **Background Modes** が自動的に追加されているか確認
   - もし無い場合: "+ Capability" → "Background Modes" を追加
   - ✅ "Audio, AirPlay, and Picture in Picture" にチェック

### 5. ビルドとテスト

1. クリーンビルド: ⌘ + Shift + K
2. ビルド: ⌘ + R
3. 実機で動作確認

## 📱 使い方

### バックグラウンド再生のテスト

1. アプリで曲を再生
2. ホームボタンを押す（またはホームジェスチャー）
3. 音楽が流れ続けることを確認 ✅

### ロック画面コントロール

1. 曲を再生中にロック画面にする
2. ロック画面に曲名とコントロールが表示される
3. 再生/一時停止ボタンが使える ✅

### コントロールセンター

1. 曲を再生中にコントロールセンターを開く
2. 音楽コントロールが表示される
3. 再生/一時停止、次の曲、前の曲が使える ✅

### 次の曲/前の曲機能

- プレイリストに複数の曲を追加しておく
- ロック画面やコントロールセンターの「>>」「<<」ボタンで曲送り

## 🔍 トラブルシューティング

### バックグラウンドで音が止まる

**原因**: Info.plistの設定が不足している
**解決**: 上記の「Info.plistの設定」を再確認

### ロック画面に何も表示されない

**原因**: Now Playing情報が更新されていない
**解決**: 
1. 曲を再生してみる
2. 一度停止して再度再生
3. Xcodeのコンソールで「✅ Now Playing更新」のログを確認

### コントロールが反応しない

**原因**: オーディオセッションが正しく設定されていない
**解決**:
1. アプリを完全に終了
2. 再度起動
3. Xcodeのコンソールで以下のログを確認:
   - "✅ オーディオセッション設定完了（バックグラウンド再生対応）"
   - "✅ メディアコントロール設定完了"

### 次の曲/前の曲が動作しない

**原因**: プレイリストに曲が1曲しかない
**解決**: プレイリストに複数の曲を追加する

## 📝 注意事項

- **実機でのみ動作**: シミュレーターではバックグラウンド再生が制限されています
- **YouTube利用規約**: バックグラウンド再生はYouTubeの規約に抵触する可能性があります
- **App Store公開**: 公開する場合は、YouTubeの公式APIを使用し、規約を遵守してください
- **電池消費**: バックグラウンド再生は電池を消費します

## 🎉 完成！

これで、YouTube Premiumのようなバックグラウンド再生機能が完成しました！

何か問題があれば、Xcodeのコンソールログを確認するか、スクリーンショットを送ってください。
